# Governanca Editorial v2

## Overview
Release focada em hardening do sistema de decisoes editoriais, com autorizacao baseada em roles (RBAC) e melhorias de UX na timeline.

---

## A) RBAC - Autorizacao para Marcacao Golden

### Implementacao
- **Header-based role extraction**: `X-User-Role` com fallback chain
  - `viewer` -> 403 Forbidden
  - `editor` -> permitido
  - `admin` -> permitido
  - `workspace-owner` (default) -> mapeado para `editor`
- **Endpoint protegido**: `POST /api/v2/threads/{thread_id}/editorial-decisions/golden`

### Contrato
```
POST /api/v2/threads/{thread_id}/editorial-decisions/golden
Headers:
  X-User-Role: viewer|editor|admin|workspace-owner (opcional, default: workspace-owner)
  Idempotency-Key: <string> (obrigatorio)

Responses:
  200 - Golden marcado com sucesso
  403 - Role nao autorizado (viewer)
  422 - Validacao falhou (justificativa vazia, scope invalido)
  404 - Thread ou run nao encontrado
```

### Test Coverage
- `test_editorial_golden_requires_editor_or_admin_role`: valida 403 para viewer
- `test_editorial_golden_fallback_role_to_editor`: valida fallback para editor

---

## B) Timeline Editorial - Humanizacao de Eventos

### Implementacao
- **`toHumanTimelineEvent`**: agora aceita objeto `TimelineEvent` com payload
- **Labels contextuais** para `EditorialGoldenMarked`:
  - `scope: "global"` -> "Golden global definido"
  - `scope: "objective"` -> "Golden de objetivo definido"
  - Fallback (sem payload) -> "Golden marcado"

### UX Impact
Timeline do workspace agora mostra mensagens claras quando golden e definido, distiguindo entre escopo global e por objetivo.

### Test Coverage
- `humanizes EditorialGoldenMarked with global scope`
- `humanizes EditorialGoldenMarked with objective scope`
- `falls back to generic label for EditorialGoldenMarked without payload`

---

## C) Hardening Baseline-None

### Contrato Valido
Quando nao ha baseline disponivel (ex: unica run no thread):
```json
{
  "run_id": "run-xxx",
  "baseline_run_id": null,
  "source": "none",
  "objective_key": ""
}
```

### Metricas
- `editorial_baseline_resolved_total`: incrementado em toda resolucao
- `editorial_baseline_source:none`: incrementado quando source=none

### Test Coverage
- `test_baseline_none_contract_when_no_baseline_available`: valida contrato
- `test_baseline_none_increments_metrics`: valida metricas

---

## Metricas de Editorial (existentes)

| Metrica | Tipo | Descricao |
|---------|------|-----------|
| `editorial_golden_marked_total` | Counter | Total de marcacoes golden |
| `editorial_golden_marked_scope:global` | Counter | Golden global |
| `editorial_golden_marked_scope:objective` | Counter | Golden por objetivo |
| `editorial_baseline_resolved_total` | Counter | Total de resolucoes de baseline |
| `editorial_baseline_source:objective_golden` | Counter | Baseline de golden objetivo |
| `editorial_baseline_source:global_golden` | Counter | Baseline de golden global |
| `editorial_baseline_source:previous` | Counter | Baseline de versao anterior |
| `editorial_baseline_source:none` | Counter | Sem baseline disponivel |
| `editorial_decisions_list_total` | Counter | Listagens de decisoes |

---

## Test Summary

| Suite | Tests | Status |
|-------|-------|--------|
| Backend API v2 | 27 | PASS |
| Frontend Workspace | 34 | PASS |

### Novos Testes
- Backend: +4 (RBAC x2, Baseline-none x2)
- Frontend: +3 (Timeline humanization x3)

---

## Migration Notes
- Nenhuma migracao necessaria
- Backward compatible: sem header X-User-Role funciona como antes (editor)
- Frontend ja utiliza payload da timeline (existente na API)

---

## Commits
1. `feat(rbac): enforce editor/admin role for editorial golden marking`
2. `feat(timeline): humanize EditorialGoldenMarked events with scope awareness`
3. `test(hardening): add contract tests for baseline-none scenario`
